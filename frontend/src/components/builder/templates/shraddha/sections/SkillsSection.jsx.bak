import { useState } from "react";
import { Code, Plus, X } from "lucide-react";
import { cn } from "../../../../../lib/utils";
import { EditableText, EmptyState } from "../../../shared";
import useBuildStore from "../../../../../store/Build.store";
import SectionHeader from "./SectionHeader";

/**
 * Skills Section for Shraddha template
 * Displays skills grouped by category
 */
export default function SkillsSection({ data = {}, sectionId, settings = {} }) {
  const updateSectionData = useBuildStore((state) => state.updateSectionData);
  const [editingCategory, setEditingCategory] = useState(null);

  const categories = data.categories || [];

  const handleCategoryNameChange = (index, name) => {
    const newCategories = [...categories];
    newCategories[index] = { ...newCategories[index], name };
    updateSectionData("skills", { ...data, categories: newCategories });
  };

  const handleSkillsChange = (index, skillsString) => {
    const items = skillsString
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean);
    const newCategories = [...categories];
    newCategories[index] = { ...newCategories[index], items };
    updateSectionData("skills", { ...data, categories: newCategories });
  };

  const handleAddCategory = () => {
    const newCategories = [...categories, { name: "New Category", items: [] }];
    updateSectionData("skills", { ...data, categories: newCategories });
  };

  const handleRemoveCategory = (index) => {
    const newCategories = categories.filter((_, i) => i !== index);
    updateSectionData("skills", { ...data, categories: newCategories });
  };

  // Simple flat list (no categories)
  if (!categories.length && Array.isArray(data)) {
    return (
      <div className="mb-4">
        <SectionHeader title="Skills" />
        <div className="flex flex-wrap gap-1">
          {data.map((skill, idx) => (
            <span
              key={idx}
              className="px-2 py-1 text-sm bg-gray-100 text-gray-700 rounded"
            >
              {skill}
            </span>
          ))}
        </div>
      </div>
    );
  }

  if (!categories || categories.length === 0) {
    return (
      <div className="mb-4">
        <SectionHeader title="Skills" />
        <EmptyState
          title="No skills added"
          description="Click to add your skills"
          onAdd={handleAddCategory}
          icon={Code}
        />
      </div>
    );
  }

  return (
    <div className="mb-4">
      <SectionHeader title="Skills" />

      <div className="space-y-2">
        {categories.map((category, index) => (
          <div
            key={index}
            className="relative group"
            onMouseEnter={() => setEditingCategory(index)}
            onMouseLeave={() => setEditingCategory(null)}
          >
            <div className="flex items-start gap-2">
              {/* Category Name */}
              <EditableText
                value={category.name}
                onChange={(val) => handleCategoryNameChange(index, val)}
                placeholder="Category"
                className="text-sm font-medium text-gray-700 min-w-[120px]"
                as="span"
              />
              <span className="text-gray-400">:</span>

              {/* Skills */}
              <div className="flex-1">
                <div className="flex flex-wrap gap-1">
                  {(category.items || []).map((skill, idx) => (
                    <span
                      key={idx}
                      className="px-2 py-0.5 text-sm bg-gray-100 text-gray-700 rounded"
                    >
                      {skill}
                    </span>
                  ))}
                </div>
                <EditableText
                  value={(category.items || []).join(", ")}
                  onChange={(val) => handleSkillsChange(index, val)}
                  placeholder="Add skills (comma separated)"
                  className="text-xs text-gray-500 italic mt-1"
                  as="span"
                />
              </div>

              {/* Remove Category */}
              {editingCategory === index && (
                <button
                  onClick={() => handleRemoveCategory(index)}
                  className="p-1 rounded hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <X className="w-3.5 h-3.5 text-red-500" />
                </button>
              )}
            </div>
          </div>
        ))}
      </div>

      {/* Add Category Button */}
      <button
        onClick={handleAddCategory}
        className="mt-2 flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 hover:underline"
      >
        <Plus className="w-3.5 h-3.5" />
        Add Category
      </button>
    </div>
  );
}
