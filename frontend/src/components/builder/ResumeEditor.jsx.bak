import React from "react";
import { useBuildStore, useResumeData } from "../../store/Build.store";
import { cn } from "../../lib/utils";
import { getSectionComponent, DEFAULT_TEMPLATE } from "./templates";
import { ConfirmDialog } from "./shared";

// Fallback imports for legacy section types
import { GenericSection } from "./sections/SectionComponents";

const ResumeEditor = () => {
  const { confirmDialog, setConfirmDialog } = useBuildStore();
  const resumeData = useResumeData();
  const {
    sections,
    theme,
    template = DEFAULT_TEMPLATE,
    sectionSettings = {},
  } = resumeData;

  // Map theme values to actual CSS
  const marginMap = { 1: "px-6", 2: "px-10", 3: "px-14", 4: "px-20" };
  const spacingMap = {
    1: "space-y-2",
    2: "space-y-4",
    3: "space-y-6",
    4: "space-y-8",
  };
  const fontSizeMap = {
    small: "text-sm",
    medium: "text-base",
    large: "text-lg",
  };

  // Normalize data format for template sections
  // The store has { items: [...] } or { content: "..." } but templates expect arrays/strings directly
  const normalizeData = (sectionType, rawData) => {
    if (!rawData) return rawData;

    // Handle header section (has direct fields like fullName, email, etc.)
    if (sectionType === "header") {
      return rawData;
    }

    // Handle skills section (expects object with categories or flat array)
    if (sectionType === "skills") {
      // If it already has categories, pass as-is
      if (rawData.categories !== undefined) {
        return rawData;
      }
      // If it has items array (flat skills list), pass the array
      if (rawData.items !== undefined) {
        return rawData.items;
      }
      return rawData;
    }

    // Handle sections with content string (summary, objective)
    if (rawData.content !== undefined) {
      return rawData.content;
    }

    // Handle sections with items array (experience, education, projects, etc.)
    if (rawData.items !== undefined) {
      return rawData.items;
    }

    return rawData;
  };

  const renderSection = (section) => {
    // Get section component from template registry
    const SectionComponent = getSectionComponent(template, section.type);

    if (SectionComponent) {
      // New template system - pass normalized data
      const rawData = section.data;
      const sectionData = normalizeData(section.type, rawData);
      const settings = sectionSettings[section.type] || {};

      return (
        <SectionComponent
          key={section.id}
          data={sectionData}
          sectionId={section.id}
          sectionType={section.type}
          settings={settings}
          themeColor={theme?.primaryColor}
        />
      );
    }

    // Fallback for legacy/unknown section types
    return (
      <GenericSection
        key={section.id}
        section={section}
        themeColor={theme?.primaryColor}
      />
    );
  };

  return (
    <div className="flex-1 bg-muted/50 dark:bg-muted/20 min-h-screen pt-20 pb-10 px-4 overflow-y-auto">
      <div className="max-w-4xl mx-auto">
        {/* A4 Page Container */}
        <div
          className={cn(
            "relative bg-white dark:bg-card shadow-2xl rounded-sm mx-auto",
            "min-h-[297mm] w-full max-w-[210mm]",
            marginMap[theme?.pageMargins] || "px-10",
            "py-8",
            fontSizeMap[theme?.fontSize] || "text-base"
          )}
          style={{
            fontFamily: theme?.fontFamily || "Inter",
            lineHeight: theme?.lineHeight || 1.5,
          }}
        >
          {/* Background Pattern */}
          {theme?.background !== "plain" && theme?.background && (
            <div
              className={cn(
                "absolute inset-0 pointer-events-none opacity-5",
                theme.background === "dots" &&
                  "bg-[radial-gradient(circle,_#000_1px,_transparent_1px)] bg-[length:20px_20px]",
                theme.background === "lines" &&
                  "bg-[linear-gradient(to_bottom,_#000_1px,_transparent_1px)] bg-[length:100%_20px]",
                theme.background === "grid" &&
                  "bg-[linear-gradient(#000_1px,_transparent_1px),_linear-gradient(90deg,_#000_1px,_transparent_1px)] bg-[length:20px_20px]"
              )}
            />
          )}

          {/* Sections */}
          <div
            className={cn(
              spacingMap[theme?.sectionSpacing] || "space-y-4",
              "relative"
            )}
          >
            {sections?.map(renderSection)}
          </div>
        </div>

        {/* Page indicator */}
        <div className="text-center mt-4 text-sm text-muted-foreground">
          Page 1 of 1
        </div>
      </div>

      {/* Global Confirmation Dialog */}
      <ConfirmDialog
        isOpen={confirmDialog?.isOpen}
        title={confirmDialog?.title}
        message={confirmDialog?.message}
        onConfirm={() => {
          confirmDialog?.onConfirm?.();
          setConfirmDialog({ isOpen: false });
        }}
        onCancel={() => {
          confirmDialog?.onCancel?.();
          setConfirmDialog({ isOpen: false });
        }}
      />
    </div>
  );
};

export default ResumeEditor;
