name: Deploy Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'packages/shared-types/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Enable Corepack for pnpm
        run: corepack enable pnpm
          
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_ENV"
          
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build shared types
        run: pnpm --filter @resumer/shared-types build
        
      - name: Type check backend
        run: pnpm --filter backend typecheck
        
      - name: Build backend
        run: pnpm --filter backend build
        
      - name: Prepare deployment package
        run: |
          mkdir -p deploy-package
          
          # Copy compiled backend code
          cp -r backend/dist deploy-package/dist
          
          # Copy web.config (required for Windows/iisnode)
          cp backend/web.config deploy-package/web.config
          
          # Copy backend package.json and remove workspace: protocol (npm can't handle it)
          cp backend/package.json deploy-package/package.json
          cd deploy-package
          node -e "const p=require('./package.json'); delete p.dependencies['@resumer/shared-types']; require('fs').writeFileSync('package.json', JSON.stringify(p,null,2))"
          
          # Copy shared-types package (already built, install manually)
          mkdir -p node_modules/@resumer/shared-types
          cp -r ../packages/shared-types/dist node_modules/@resumer/shared-types/dist
          cp ../packages/shared-types/package.json node_modules/@resumer/shared-types/package.json
          
          # Install only production dependencies for backend
          npm install --omit=dev --ignore-scripts
          
      - name: Create deployment archive
        run: |
          cd deploy-package
          zip -r ../deploy.zip .
          
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./deploy.zip
          
      - name: Deployment Summary
        run: |
          echo "‚úÖ Backend deployed to Azure successfully!"
          echo "üîó Your API is available at: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "üè• Health check: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/v1/health"
